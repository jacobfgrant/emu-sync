<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>emu-sync</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #ffffff;
  --bg-card: #f8f9fa;
  --bg-row-alt: #f1f3f5;
  --bg-row-hover: #e9ecef;
  --bg-header: rgba(255, 255, 255, 0.95);
  --bg-footer: rgba(255, 255, 255, 0.95);
  --text: #1a1a1a;
  --text-secondary: #6b7280;
  --text-dim: #9ca3af;
  --border: #e5e7eb;
  --border-light: #f0f0f0;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --success: #16a34a;
  --danger: #dc2626;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #111827;
    --bg-card: #1f2937;
    --bg-row-alt: #1a2332;
    --bg-row-hover: #263348;
    --bg-header: rgba(17, 24, 39, 0.95);
    --bg-footer: rgba(17, 24, 39, 0.95);
    --text: #f3f4f6;
    --text-secondary: #9ca3af;
    --text-dim: #6b7280;
    --border: #374151;
    --border-light: #2d3748;
    --accent: #3b82f6;
    --accent-hover: #60a5fa;
    --success: #22c55e;
    --danger: #ef4444;
  }
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--bg-header);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px;
}

.header-inner {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  flex-wrap: wrap;
  gap: 8px;
}

.header h1 {
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: -0.01em;
}

.header .totals {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.header .totals .selected-size {
  color: var(--text);
  font-weight: 600;
}

main {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px 20px 140px;
}

.loading {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-secondary);
  font-size: 0.95rem;
}

.system-card {
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 12px;
  background: var(--bg-card);
  overflow: hidden;
}

.system-card summary {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  cursor: pointer;
  gap: 12px;
  min-height: 52px;
  list-style: none;
  user-select: none;
  -webkit-user-select: none;
}

.system-card summary::-webkit-details-marker { display: none; }

.system-card summary .caret {
  font-size: 0.65rem;
  color: var(--text-dim);
  margin-left: auto;
  transition: transform 0.15s ease;
  flex-shrink: 0;
}

.system-card[open] summary .caret {
  transform: rotate(90deg);
}

.system-checkbox {
  width: 20px;
  height: 20px;
  accent-color: var(--accent);
  cursor: pointer;
  flex-shrink: 0;
}

.system-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
  gap: 1px;
}

.system-name {
  font-weight: 600;
  font-size: 0.95rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.system-meta {
  color: var(--text-secondary);
  font-size: 0.8rem;
  white-space: nowrap;
}

.system-actions {
  display: flex;
  gap: 8px;
  padding: 2px 16px 10px;
}

.system-actions button {
  font-size: 0.78rem;
  padding: 4px 14px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: var(--bg);
  color: var(--text-secondary);
  cursor: pointer;
  min-height: 32px;
  transition: border-color 0.1s, color 0.1s;
}

.system-actions button:hover {
  color: var(--text);
  border-color: var(--text-secondary);
}

.file-list {
  border-top: 1px solid var(--border);
}

.file-row {
  display: flex;
  align-items: center;
  padding: 8px 16px 8px 28px;
  gap: 12px;
  min-height: 44px;
  transition: background-color 0.08s;
}

.file-row:hover {
  background: var(--bg-row-hover);
}

.file-row:nth-child(even) {
  background: var(--bg-row-alt);
}

.file-row:nth-child(even):hover {
  background: var(--bg-row-hover);
}

.file-row:not(:last-child) {
  border-bottom: 1px solid var(--border-light);
}

.file-checkbox {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
  cursor: pointer;
  flex-shrink: 0;
}

.file-name {
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 0.875rem;
}

.file-size {
  margin-left: auto;
  color: var(--text-dim);
  font-size: 0.8rem;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
  flex-shrink: 0;
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-footer);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-top: 1px solid var(--border);
  padding: 14px 20px;
  z-index: 10;
}

.footer-inner {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  border: none;
  border-radius: 7px;
  padding: 10px 28px;
  font-size: 0.925rem;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
  white-space: nowrap;
  transition: background-color 0.1s;
}

.btn:disabled { opacity: 0.45; cursor: not-allowed; }

.btn-primary {
  background: var(--accent);
  color: #fff;
}

.btn-primary:hover:not(:disabled) { background: var(--accent-hover); }

.btn-secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
  padding: 9px 28px;
}

.btn-secondary:hover:not(:disabled) {
  color: var(--text);
  border-color: var(--text-secondary);
}

.status-msg {
  font-size: 0.85rem;
  color: var(--text-secondary);
  flex: 1;
  min-width: 0;
}

.status-msg.success { color: var(--success); font-weight: 500; }
.status-msg.error { color: var(--danger); font-weight: 500; }

.disconnected-banner {
  background: var(--danger);
  color: #fff;
  text-align: center;
  padding: 10px 20px;
  font-size: 0.9rem;
  font-weight: 500;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <h1>emu-sync</h1>
    <div class="totals">
      <span class="selected-size" id="selected-size">--</span>
      <span> of </span>
      <span id="total-size">--</span>
      <span> selected</span>
    </div>
  </div>
</div>

<main id="main">
  <div class="loading" id="loading">Loading systems...</div>
</main>

<div class="footer">
  <div class="footer-inner">
    <button class="btn btn-primary" id="save-btn" disabled>Save</button>
    <button class="btn btn-secondary" id="exit-btn" disabled>Save &amp; Exit</button>
    <span class="status-msg" id="status-msg"></span>
  </div>
</div>

<script>
(function() {
  "use strict";

  var systems = [];
  var saving = false;

  function formatSize(bytes) {
    if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + " GB";
    if (bytes >= 1048576) return Math.round(bytes / 1048576) + " MB";
    if (bytes >= 1024) return Math.round(bytes / 1024) + " KB";
    return bytes + " B";
  }

  function computeTotals() {
    var selected = 0, total = 0;
    for (var i = 0; i < systems.length; i++) {
      var s = systems[i];
      total += s.totalSize;
      for (var j = 0; j < s.files.length; j++) {
        if (s.files[j].selected) selected += s.files[j].size;
      }
    }
    return { selected: selected, total: total };
  }

  function updateTotals() {
    var t = computeTotals();
    document.getElementById("selected-size").textContent = formatSize(t.selected);
    document.getElementById("total-size").textContent = formatSize(t.total);
  }

  function systemState(sys) {
    var sel = 0;
    for (var i = 0; i < sys.files.length; i++) {
      if (sys.files[i].selected) sel++;
    }
    if (sel === 0) return "none";
    if (sel === sys.files.length) return "all";
    return "partial";
  }

  function updateSystemCheckbox(sysIdx) {
    var cb = document.getElementById("sys-cb-" + sysIdx);
    var state = systemState(systems[sysIdx]);
    cb.checked = state !== "none";
    cb.indeterminate = state === "partial";
    var meta = document.getElementById("sys-meta-" + sysIdx);
    var sys = systems[sysIdx];
    var sel = 0;
    for (var i = 0; i < sys.files.length; i++) {
      if (sys.files[i].selected) sel++;
    }
    meta.textContent = sel + "/" + sys.files.length + " files \u00B7 " + sys.totalSizeFormatted;
  }

  function setAllFiles(sysIdx, value) {
    var sys = systems[sysIdx];
    for (var i = 0; i < sys.files.length; i++) {
      sys.files[i].selected = value;
      var fcb = document.getElementById("file-cb-" + sysIdx + "-" + i);
      if (fcb) fcb.checked = value;
    }
    updateSystemCheckbox(sysIdx);
    updateTotals();
  }

  function render() {
    var main = document.getElementById("main");
    main.innerHTML = "";

    for (var si = 0; si < systems.length; si++) {
      var sys = systems[si];
      var card = document.createElement("details");
      card.className = "system-card";

      var summary = document.createElement("summary");

      var cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "system-checkbox";
      cb.id = "sys-cb-" + si;
      cb.dataset.sysIdx = si;
      cb.addEventListener("change", (function(idx) {
        return function(e) {
          e.stopPropagation();
          setAllFiles(idx, e.target.checked);
        };
      })(si));
      cb.addEventListener("click", function(e) { e.stopPropagation(); });

      var info = document.createElement("div");
      info.className = "system-info";

      var name = document.createElement("span");
      name.className = "system-name";
      name.textContent = sys.dir;

      var meta = document.createElement("span");
      meta.className = "system-meta";
      meta.id = "sys-meta-" + si;

      info.appendChild(name);
      info.appendChild(meta);

      var caret = document.createElement("span");
      caret.className = "caret";
      caret.textContent = "\u25B6";

      summary.appendChild(cb);
      summary.appendChild(info);
      summary.appendChild(caret);
      card.appendChild(summary);

      var actions = document.createElement("div");
      actions.className = "system-actions";

      var selAllBtn = document.createElement("button");
      selAllBtn.textContent = "Select All";
      selAllBtn.addEventListener("click", (function(idx) {
        return function() { setAllFiles(idx, true); };
      })(si));

      var deselBtn = document.createElement("button");
      deselBtn.textContent = "Deselect All";
      deselBtn.addEventListener("click", (function(idx) {
        return function() { setAllFiles(idx, false); };
      })(si));

      actions.appendChild(selAllBtn);
      actions.appendChild(deselBtn);
      card.appendChild(actions);

      var fileList = document.createElement("div");
      fileList.className = "file-list";

      for (var fi = 0; fi < sys.files.length; fi++) {
        var file = sys.files[fi];
        var row = document.createElement("div");
        row.className = "file-row";

        var fcb = document.createElement("input");
        fcb.type = "checkbox";
        fcb.className = "file-checkbox";
        fcb.id = "file-cb-" + si + "-" + fi;
        fcb.checked = file.selected;
        fcb.dataset.sysIdx = si;
        fcb.dataset.fileIdx = fi;
        fcb.addEventListener("change", (function(sIdx, fIdx) {
          return function(e) {
            systems[sIdx].files[fIdx].selected = e.target.checked;
            updateSystemCheckbox(sIdx);
            updateTotals();
          };
        })(si, fi));

        var fname = document.createElement("span");
        fname.className = "file-name";
        fname.textContent = file.name;

        var fsize = document.createElement("span");
        fsize.className = "file-size";
        fsize.textContent = file.sizeFormatted;

        row.appendChild(fcb);
        row.appendChild(fname);
        row.appendChild(fsize);
        fileList.appendChild(row);
      }

      card.appendChild(fileList);
      main.appendChild(card);
      updateSystemCheckbox(si);
    }

    updateTotals();
    document.getElementById("save-btn").disabled = false;
    document.getElementById("exit-btn").disabled = false;
  }

  function buildSelections() {
    var sel = {};
    for (var i = 0; i < systems.length; i++) {
      for (var j = 0; j < systems[i].files.length; j++) {
        var f = systems[i].files[j];
        sel[f.key] = f.selected;
      }
    }
    return sel;
  }

  function doSave(exit) {
    if (saving) return;
    saving = true;
    var saveBtn = document.getElementById("save-btn");
    var exitBtn = document.getElementById("exit-btn");
    var msg = document.getElementById("status-msg");
    saveBtn.disabled = true;
    exitBtn.disabled = true;
    msg.textContent = "Saving...";
    msg.className = "status-msg";

    fetch("/api/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ selections: buildSelections(), exit: exit })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      saving = false;
      if (data.ok) {
        if (exit) {
          msg.textContent = "Saved. Closing...";
          msg.className = "status-msg success";
          window.close();
          // If window.close() didn't work (browser may block it)
          setTimeout(function() {
            msg.textContent = "Saved to " + data.configPath + ". You can close this tab.";
          }, 500);
        } else {
          msg.textContent = "Saved to " + data.configPath;
          msg.className = "status-msg success";
          saveBtn.disabled = false;
          exitBtn.disabled = false;
        }
      } else {
        msg.textContent = "Error: " + (data.error || "unknown");
        msg.className = "status-msg error";
        saveBtn.disabled = false;
        exitBtn.disabled = false;
      }
    })
    .catch(function(err) {
      saving = false;
      msg.textContent = "Error: " + err.message;
      msg.className = "status-msg error";
      saveBtn.disabled = false;
      exitBtn.disabled = false;
    });
  }

  function showDisconnected() {
    var banner = document.createElement("div");
    banner.className = "disconnected-banner";
    banner.textContent = "Server disconnected. You can close this tab.";
    document.body.insertBefore(banner, document.body.firstChild);
    document.getElementById("save-btn").disabled = true;
    document.getElementById("exit-btn").disabled = true;
    document.getElementById("status-msg").textContent = "";
  }

  function waitForShutdown() {
    fetch("/api/wait").then(showDisconnected).catch(showDisconnected);
  }

  document.getElementById("save-btn").addEventListener("click", function() {
    doSave(false);
  });
  document.getElementById("exit-btn").addEventListener("click", function() {
    doSave(true);
  });

  fetch("/api/systems")
    .then(function(res) { return res.json(); })
    .then(function(data) {
      systems = data.systems || [];
      render();
      waitForShutdown();
    })
    .catch(function(err) {
      document.getElementById("loading").textContent = "Error loading: " + err.message;
    });
})();
</script>
</body>
</html>
