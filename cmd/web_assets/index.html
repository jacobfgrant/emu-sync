<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>emu-sync</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #ffffff;
  --bg-card: #f8f9fa;
  --bg-row-alt: #f1f3f5;
  --bg-row-hover: #e9ecef;
  --bg-header: rgba(255, 255, 255, 0.95);
  --bg-footer: rgba(255, 255, 255, 0.95);
  --text: #1a1a1a;
  --text-secondary: #6b7280;
  --text-dim: #9ca3af;
  --border: #e5e7eb;
  --border-light: #f0f0f0;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --success: #16a34a;
  --danger: #dc2626;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #111827;
    --bg-card: #1f2937;
    --bg-row-alt: #1a2332;
    --bg-row-hover: #263348;
    --bg-header: rgba(17, 24, 39, 0.95);
    --bg-footer: rgba(17, 24, 39, 0.95);
    --text: #f3f4f6;
    --text-secondary: #9ca3af;
    --text-dim: #6b7280;
    --border: #374151;
    --border-light: #2d3748;
    --accent: #3b82f6;
    --accent-hover: #60a5fa;
    --success: #22c55e;
    --danger: #ef4444;
  }
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--bg-header);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px;
}

.header-inner {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  flex-wrap: wrap;
  gap: 8px;
}

.header h1 {
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: -0.01em;
}

.header .totals {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.header .totals .selected-size {
  color: var(--text);
  font-weight: 600;
}

main {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px 20px 140px;
}

.loading {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-secondary);
  font-size: 0.95rem;
}

.system-card {
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 12px;
  background: var(--bg-card);
  overflow: hidden;
}

.system-card summary {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  cursor: pointer;
  gap: 12px;
  min-height: 52px;
  list-style: none;
  user-select: none;
  -webkit-user-select: none;
}

.system-card summary::-webkit-details-marker { display: none; }

.system-card summary .caret {
  font-size: 0.65rem;
  color: var(--text-dim);
  margin-left: auto;
  transition: transform 0.15s ease;
  flex-shrink: 0;
}

.system-card[open] summary .caret {
  transform: rotate(90deg);
}

.system-checkbox {
  width: 20px;
  height: 20px;
  accent-color: var(--accent);
  cursor: pointer;
  flex-shrink: 0;
}

.system-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
  gap: 1px;
}

.system-name {
  font-weight: 600;
  font-size: 0.95rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.system-meta {
  color: var(--text-secondary);
  font-size: 0.8rem;
  white-space: nowrap;
}

.system-actions {
  display: flex;
  gap: 8px;
  padding: 2px 16px 10px;
}

.system-actions button {
  font-size: 0.78rem;
  padding: 4px 14px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: var(--bg);
  color: var(--text-secondary);
  cursor: pointer;
  min-height: 32px;
  transition: border-color 0.1s, color 0.1s;
}

.system-actions button:hover {
  color: var(--text);
  border-color: var(--text-secondary);
}

.file-list {
  border-top: 1px solid var(--border);
}

.file-row {
  display: flex;
  align-items: center;
  padding: 8px 16px 8px 28px;
  gap: 12px;
  min-height: 44px;
  transition: background-color 0.08s;
}

.file-row:hover {
  background: var(--bg-row-hover);
}

.file-row:nth-child(even) {
  background: var(--bg-row-alt);
}

.file-row:nth-child(even):hover {
  background: var(--bg-row-hover);
}

.file-row:not(:last-child) {
  border-bottom: 1px solid var(--border-light);
}

.file-checkbox {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
  cursor: pointer;
  flex-shrink: 0;
}

.file-name {
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 0.875rem;
}

.file-size {
  margin-left: auto;
  color: var(--text-dim);
  font-size: 0.8rem;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
  flex-shrink: 0;
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-footer);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-top: 1px solid var(--border);
  padding: 14px 20px;
  z-index: 10;
}

.footer-inner {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  border: none;
  border-radius: 7px;
  padding: 10px 28px;
  font-size: 0.925rem;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
  white-space: nowrap;
  transition: background-color 0.1s;
}

.btn:disabled { opacity: 0.45; cursor: not-allowed; }

.btn-primary {
  background: var(--accent);
  color: #fff;
}

.btn-primary:hover:not(:disabled) { background: var(--accent-hover); }

.btn-secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
  padding: 9px 28px;
}

.btn-secondary:hover:not(:disabled) {
  color: var(--text);
  border-color: var(--text-secondary);
}

.status-msg {
  font-size: 0.85rem;
  color: var(--text-secondary);
  flex: 1;
  min-width: 0;
}

.status-msg.success { color: var(--success); font-weight: 500; }
.status-msg.error { color: var(--danger); font-weight: 500; }

.disconnected-banner {
  background: var(--danger);
  color: #fff;
  text-align: center;
  padding: 10px 20px;
  font-size: 0.9rem;
  font-weight: 500;
}

.result-card {
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: 8px;
  margin-bottom: 20px;
  background: var(--bg-card);
  padding: 16px;
}

.result-card.success { border-left-color: var(--success); }
.result-card.error { border-left-color: var(--danger); }

.result-header {
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 4px;
}

.result-summary {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.result-log {
  max-height: 300px;
  overflow-y: auto;
  font-size: 0.8rem;
  font-family: ui-monospace, "SF Mono", Monaco, "Cascadia Mono", monospace;
  line-height: 1.6;
}

.result-log:empty { display: none; }

.log-line { color: var(--text-secondary); }
.log-line.downloaded { color: var(--text); }
.log-line.error { color: var(--danger); }
.log-line.deleted { color: var(--text-dim); }
.log-line.retained { color: var(--text-secondary); font-style: italic; }
.log-line.mismatch { color: var(--danger); }
.log-line.missing { color: var(--danger); }

.result-section-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-top: 10px;
  margin-bottom: 2px;
}

.footer-separator {
  width: 1px;
  height: 24px;
  background: var(--border);
  flex-shrink: 0;
}

.delete-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  color: var(--text-secondary);
  user-select: none;
  -webkit-user-select: none;
}

.delete-toggle.danger { color: var(--danger); }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <h1>emu-sync</h1>
    <div class="totals">
      <span class="selected-size" id="selected-size">--</span>
      <span> of </span>
      <span id="total-size">--</span>
      <span> selected</span>
    </div>
  </div>
</div>

<main id="main">
  <div class="loading" id="loading">Loading systems...</div>
</main>

<div class="footer">
  <div class="footer-inner">
    <button class="btn btn-primary" id="save-btn" disabled>Save</button>
    <button class="btn btn-secondary" id="exit-btn" disabled>Save &amp; Exit</button>
    <button class="btn btn-secondary" id="quit-btn" disabled>Exit</button>
    <div class="footer-separator"></div>
    <button class="btn btn-secondary" id="verify-btn" disabled>Verify</button>
    <button class="btn btn-secondary" id="sync-btn" disabled>Sync</button>
    <label class="delete-toggle" id="delete-toggle-label">
      <input type="checkbox" id="delete-toggle">
      <span>Remove deselected files</span>
    </label>
    <span class="status-msg" id="op-status" style="display:none"></span>
    <span class="status-msg" id="status-msg"></span>
  </div>
</div>

<script>
(function() {
  "use strict";

  var systems = [];
  var saving = false;
  var syncing = false;
  var verifying = false;
  var syncEventSource = null;

  function formatSize(bytes) {
    if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + " GB";
    if (bytes >= 1048576) return Math.round(bytes / 1048576) + " MB";
    if (bytes >= 1024) return Math.round(bytes / 1024) + " KB";
    return bytes + " B";
  }

  function computeTotals() {
    var selected = 0, total = 0;
    for (var i = 0; i < systems.length; i++) {
      var s = systems[i];
      total += s.totalSize;
      for (var j = 0; j < s.files.length; j++) {
        if (s.files[j].selected) selected += s.files[j].size;
      }
    }
    return { selected: selected, total: total };
  }

  function updateTotals() {
    var t = computeTotals();
    document.getElementById("selected-size").textContent = formatSize(t.selected);
    document.getElementById("total-size").textContent = formatSize(t.total);
  }

  function systemState(sys) {
    var sel = 0;
    for (var i = 0; i < sys.files.length; i++) {
      if (sys.files[i].selected) sel++;
    }
    if (sel === 0) return "none";
    if (sel === sys.files.length) return "all";
    return "partial";
  }

  function updateSystemCheckbox(sysIdx) {
    var cb = document.getElementById("sys-cb-" + sysIdx);
    var state = systemState(systems[sysIdx]);
    cb.checked = state !== "none";
    cb.indeterminate = state === "partial";
    var meta = document.getElementById("sys-meta-" + sysIdx);
    var sys = systems[sysIdx];
    var sel = 0;
    for (var i = 0; i < sys.files.length; i++) {
      if (sys.files[i].selected) sel++;
    }
    meta.textContent = sel + "/" + sys.files.length + " files \u00B7 " + sys.totalSizeFormatted;
  }

  function setAllFiles(sysIdx, value) {
    var sys = systems[sysIdx];
    for (var i = 0; i < sys.files.length; i++) {
      sys.files[i].selected = value;
      var fcb = document.getElementById("file-cb-" + sysIdx + "-" + i);
      if (fcb) fcb.checked = value;
    }
    updateSystemCheckbox(sysIdx);
    updateTotals();
  }

  function render() {
    var main = document.getElementById("main");
    main.innerHTML = "";

    for (var si = 0; si < systems.length; si++) {
      var sys = systems[si];
      var card = document.createElement("details");
      card.className = "system-card";

      var summary = document.createElement("summary");

      var cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "system-checkbox";
      cb.id = "sys-cb-" + si;
      cb.dataset.sysIdx = si;
      cb.addEventListener("change", (function(idx) {
        return function(e) {
          e.stopPropagation();
          setAllFiles(idx, e.target.checked);
        };
      })(si));
      cb.addEventListener("click", function(e) { e.stopPropagation(); });

      var info = document.createElement("div");
      info.className = "system-info";

      var name = document.createElement("span");
      name.className = "system-name";
      name.textContent = sys.dir;

      var meta = document.createElement("span");
      meta.className = "system-meta";
      meta.id = "sys-meta-" + si;

      info.appendChild(name);
      info.appendChild(meta);

      var caret = document.createElement("span");
      caret.className = "caret";
      caret.textContent = "\u25B6";

      summary.appendChild(cb);
      summary.appendChild(info);
      summary.appendChild(caret);
      card.appendChild(summary);

      var actions = document.createElement("div");
      actions.className = "system-actions";

      var selAllBtn = document.createElement("button");
      selAllBtn.textContent = "Select All";
      selAllBtn.addEventListener("click", (function(idx) {
        return function() { setAllFiles(idx, true); };
      })(si));

      var deselBtn = document.createElement("button");
      deselBtn.textContent = "Deselect All";
      deselBtn.addEventListener("click", (function(idx) {
        return function() { setAllFiles(idx, false); };
      })(si));

      actions.appendChild(selAllBtn);
      actions.appendChild(deselBtn);
      card.appendChild(actions);

      var fileList = document.createElement("div");
      fileList.className = "file-list";

      for (var fi = 0; fi < sys.files.length; fi++) {
        var file = sys.files[fi];
        var row = document.createElement("div");
        row.className = "file-row";

        var fcb = document.createElement("input");
        fcb.type = "checkbox";
        fcb.className = "file-checkbox";
        fcb.id = "file-cb-" + si + "-" + fi;
        fcb.checked = file.selected;
        fcb.dataset.sysIdx = si;
        fcb.dataset.fileIdx = fi;
        fcb.addEventListener("change", (function(sIdx, fIdx) {
          return function(e) {
            systems[sIdx].files[fIdx].selected = e.target.checked;
            updateSystemCheckbox(sIdx);
            updateTotals();
          };
        })(si, fi));

        var fname = document.createElement("span");
        fname.className = "file-name";
        fname.textContent = file.name;

        var fsize = document.createElement("span");
        fsize.className = "file-size";
        fsize.textContent = file.sizeFormatted;

        row.appendChild(fcb);
        row.appendChild(fname);
        row.appendChild(fsize);
        fileList.appendChild(row);
      }

      card.appendChild(fileList);
      main.appendChild(card);
      updateSystemCheckbox(si);
    }

    updateTotals();
    document.getElementById("save-btn").disabled = false;
    document.getElementById("exit-btn").disabled = false;
    document.getElementById("quit-btn").disabled = false;
    document.getElementById("sync-btn").disabled = false;
    document.getElementById("verify-btn").disabled = false;
  }

  function buildSelections() {
    var sel = {};
    for (var i = 0; i < systems.length; i++) {
      for (var j = 0; j < systems[i].files.length; j++) {
        var f = systems[i].files[j];
        sel[f.key] = f.selected;
      }
    }
    return sel;
  }

  function enableButtons() {
    document.getElementById("save-btn").disabled = false;
    document.getElementById("exit-btn").disabled = false;
    document.getElementById("quit-btn").disabled = false;
    if (!syncing) {
      document.getElementById("sync-btn").disabled = false;
      document.getElementById("verify-btn").disabled = false;
    }
  }

  function disableButtons() {
    document.getElementById("save-btn").disabled = true;
    document.getElementById("exit-btn").disabled = true;
    document.getElementById("quit-btn").disabled = true;
    document.getElementById("sync-btn").disabled = true;
    document.getElementById("verify-btn").disabled = true;
  }

  function doSave(exit) {
    if (saving) return;
    saving = true;
    var msg = document.getElementById("status-msg");
    disableButtons();
    msg.textContent = "Saving...";
    msg.className = "status-msg";

    fetch("/api/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ selections: buildSelections(), exit: exit, delete: document.getElementById("delete-toggle").checked })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      saving = false;
      if (data.ok) {
        if (exit) {
          msg.textContent = "Saved. Closing...";
          msg.className = "status-msg success";
          window.close();
          setTimeout(function() {
            msg.textContent = "Saved to " + data.configPath + ". You can close this tab.";
          }, 500);
        } else {
          msg.textContent = "Saved to " + data.configPath;
          msg.className = "status-msg success";
          enableButtons();
        }
      } else {
        msg.textContent = "Error: " + (data.error || "unknown");
        msg.className = "status-msg error";
        enableButtons();
      }
    })
    .catch(function(err) {
      saving = false;
      msg.textContent = "Error: " + err.message;
      msg.className = "status-msg error";
      enableButtons();
    });
  }

  function showDisconnected() {
    if (syncEventSource) { syncEventSource.close(); syncEventSource = null; }
    hideOpStatus();
    var banner = document.createElement("div");
    banner.className = "disconnected-banner";
    banner.textContent = "Server disconnected. You can close this tab.";
    document.body.insertBefore(banner, document.body.firstChild);
    disableButtons();
    document.getElementById("status-msg").textContent = "";
  }

  function waitForShutdown() {
    fetch("/api/wait").then(showDisconnected).catch(showDisconnected);
  }

  function showOpStatus(text) {
    var opStatus = document.getElementById("op-status");
    document.getElementById("sync-btn").style.display = "none";
    document.getElementById("verify-btn").style.display = "none";
    opStatus.textContent = text;
    opStatus.style.display = "";
  }

  function hideOpStatus() {
    document.getElementById("op-status").style.display = "none";
    document.getElementById("sync-btn").style.display = "";
    document.getElementById("verify-btn").style.display = "";
  }

  function getResultCard() {
    return document.getElementById("result-card");
  }

  function createResultCard(headerText, cardClass) {
    var old = getResultCard();
    if (old) old.remove();

    var card = document.createElement("div");
    card.id = "result-card";
    card.className = "result-card" + (cardClass ? " " + cardClass : "");

    var h = document.createElement("div");
    h.className = "result-header";
    h.id = "result-header";
    h.textContent = headerText;
    card.appendChild(h);

    var s = document.createElement("div");
    s.className = "result-summary";
    s.id = "result-summary";
    card.appendChild(s);

    var log = document.createElement("div");
    log.className = "result-log";
    log.id = "result-log";
    card.appendChild(log);

    var main = document.getElementById("main");
    main.insertBefore(card, main.firstChild);
    return card;
  }

  function addLogLine(text, cls) {
    var log = document.getElementById("result-log");
    if (!log) return;
    var line = document.createElement("div");
    line.className = "log-line" + (cls ? " " + cls : "");
    line.textContent = text;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
  }

  function addSectionLabel(text) {
    var log = document.getElementById("result-log");
    if (!log) return;
    var label = document.createElement("div");
    label.className = "result-section-label";
    label.textContent = text;
    log.appendChild(label);
  }

  function handleSyncEvent(evt) {
    var summary = document.getElementById("result-summary");

    if (evt.event === "complete") {
      if (syncState.downloaded === 0) addSectionLabel("Downloaded:");
      syncState.downloaded++;
      syncState.downloadedFiles.push(evt.file);
      addLogLine(evt.file, "downloaded");
    } else if (evt.event === "error") {
      if (syncState.errors === 0) addSectionLabel("Errors:");
      syncState.errors++;
      syncState.errorDetails.push(evt.file + ": " + evt.error);
      addLogLine(evt.file + " \u2014 " + evt.error, "error");
    } else if (evt.event === "delete") {
      if (syncState.deletedFiles.length === 0) addSectionLabel("Deleted:");
      syncState.deletedFiles.push(evt.file);
      addLogLine(evt.file, "deleted");
    } else if (evt.event === "retain") {
      if (syncState.retainedFiles.length === 0) addSectionLabel("Kept (delete disabled):");
      syncState.retainedFiles.push(evt.file);
      addLogLine(evt.file, "retained");
    } else if (evt.event === "skip") {
      syncState.skipped++;
    }

    if (evt.event === "done") {
      return true;
    }

    if (summary) {
      var parts = [];
      if (syncState.downloaded > 0) parts.push(syncState.downloaded + " downloaded");
      if (syncState.deletedFiles.length > 0) parts.push(syncState.deletedFiles.length + " deleted");
      if (syncState.retainedFiles.length > 0) parts.push(syncState.retainedFiles.length + " kept");
      if (syncState.errors > 0) parts.push(syncState.errors + " errors");
      summary.textContent = parts.length > 0 ? parts.join(", ") : "Starting...";
    }
    return false;
  }

  function finishSync(evt) {
    syncEventSource = null;
    syncing = false;
    hideOpStatus();
    enableButtons();

    var card = getResultCard();
    var dl = evt.downloaded || 0;
    var del = evt.deleted || 0;
    var ret = evt.retained || 0;
    var skip = evt.skipped || 0;
    var errs = evt.errors || 0;

    if (card) {
      card.className = "result-card" + (errs > 0 ? " error" : " success");
      var header = document.getElementById("result-header");
      if (header) header.textContent = errs > 0 ? "Sync completed with errors" : "Sync complete";
      var summary = document.getElementById("result-summary");
      if (summary) {
        var parts = [];
        parts.push("Downloaded " + dl);
        parts.push("deleted " + del);
        if (ret > 0) parts.push(ret + " kept (delete disabled)");
        parts.push("unchanged " + skip);
        if (errs > 0) parts.push(errs + " errors");
        summary.textContent = parts.join(", ");
      }
    }
  }

  var syncState = {};

  function doSync() {
    if (syncing || verifying) return;
    syncing = true;
    var msg = document.getElementById("status-msg");
    document.getElementById("sync-btn").disabled = true;
    document.getElementById("verify-btn").disabled = true;
    msg.textContent = "";
    msg.className = "status-msg";
    showOpStatus("Syncing...");

    syncState = { downloaded: 0, errors: 0, skipped: 0, downloadedFiles: [], deletedFiles: [], retainedFiles: [], errorDetails: [] };
    createResultCard("Syncing...");

    fetch("/api/sync", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ selections: buildSelections(), delete: document.getElementById("delete-toggle").checked })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (!data.ok) {
        syncing = false;
        hideOpStatus();
        enableButtons();
        var card = getResultCard();
        if (card) {
          card.className = "result-card error";
          document.getElementById("result-header").textContent = "Sync failed";
          document.getElementById("result-summary").textContent = data.error || "Unknown error";
        }
        return;
      }

      syncEventSource = new EventSource("/api/sync/events");
      syncEventSource.onmessage = function(e) {
        var evt;
        try { evt = JSON.parse(e.data); } catch (_) { return; }

        if (handleSyncEvent(evt)) {
          syncEventSource.close();
          finishSync(evt);
        }
      };

      syncEventSource.onerror = function() {
        syncEventSource.close();
        syncEventSource = null;
        pollSyncStatus();
      };
    })
    .catch(function(err) {
      syncing = false;
      hideOpStatus();
      enableButtons();
      msg.textContent = "Error: " + err.message;
      msg.className = "status-msg error";
    });
  }

  function pollSyncStatus() {
    fetch("/api/sync/status")
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.state === "running") {
        showOpStatus("Syncing...");
        setTimeout(pollSyncStatus, 1000);
      } else if (data.state === "complete" || data.state === "failed") {
        syncing = false;
        hideOpStatus();
        enableButtons();
        var cls = data.state === "complete" ? "success" : "error";
        var card = getResultCard();
        if (!card) createResultCard("", cls);
        card = getResultCard();
        card.className = "result-card " + cls;
        document.getElementById("result-header").textContent =
          data.state === "complete" ? "Sync complete" : "Sync failed";
        document.getElementById("result-summary").textContent = data.summary || "";
      } else {
        syncing = false;
        hideOpStatus();
        enableButtons();
      }
    })
    .catch(function() {
      syncing = false;
      hideOpStatus();
      enableButtons();
    });
  }

  function doVerify() {
    if (syncing || verifying) return;
    verifying = true;
    var msg = document.getElementById("status-msg");
    disableButtons();
    msg.textContent = "";
    msg.className = "status-msg";
    showOpStatus("Verifying...");

    fetch("/api/verify", { method: "POST" })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      verifying = false;
      hideOpStatus();
      enableButtons();

      if (data.error) {
        createResultCard("Verify failed", "error");
        document.getElementById("result-summary").textContent = data.error;
        return;
      }

      var total = (data.ok || 0) + (data.mismatch || 0) + (data.missing || 0) + (data.errors || 0);
      if (total === 0) {
        createResultCard("Nothing to verify", "");
        document.getElementById("result-summary").textContent = "No local manifest found. Run sync first.";
        return;
      }

      var hasProblems = (data.mismatch || 0) > 0 || (data.missing || 0) > 0 || (data.errors || 0) > 0;
      var cls = hasProblems ? "error" : "success";
      var header = hasProblems ? "Verify found issues" : "All files match";
      createResultCard(header, cls);

      var parts = [];
      parts.push((data.ok || 0) + " OK");
      if ((data.mismatch || 0) > 0) parts.push(data.mismatch + " mismatched");
      if ((data.missing || 0) > 0) parts.push(data.missing + " missing");
      if ((data.errors || 0) > 0) parts.push(data.errors + " errors");
      document.getElementById("result-summary").textContent = parts.join(", ");

      if (data.mismatch_files && data.mismatch_files.length > 0) {
        addSectionLabel("Mismatched (will re-download on next sync):");
        for (var i = 0; i < data.mismatch_files.length; i++) {
          addLogLine(data.mismatch_files[i], "mismatch");
        }
      }
      if (data.missing_files && data.missing_files.length > 0) {
        addSectionLabel("Missing (will re-download on next sync):");
        for (var i = 0; i < data.missing_files.length; i++) {
          addLogLine(data.missing_files[i], "missing");
        }
      }
      if (data.error_details && data.error_details.length > 0) {
        addSectionLabel("Errors:");
        for (var i = 0; i < data.error_details.length; i++) {
          addLogLine(data.error_details[i], "error");
        }
      }
    })
    .catch(function(err) {
      verifying = false;
      hideOpStatus();
      enableButtons();
      msg.textContent = "Error: " + err.message;
      msg.className = "status-msg error";
    });
  }

  function checkSyncStatus() {
    fetch("/api/sync/status")
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.state === "running") {
        syncing = true;
        document.getElementById("sync-btn").disabled = true;
        document.getElementById("verify-btn").disabled = true;
        showOpStatus("Syncing...");

        syncState = { downloaded: 0, errors: 0, skipped: 0, downloadedFiles: [], deletedFiles: [], retainedFiles: [], errorDetails: [] };
        createResultCard("Syncing...");

        syncEventSource = new EventSource("/api/sync/events");
        syncEventSource.onmessage = function(e) {
          var evt;
          try { evt = JSON.parse(e.data); } catch (_) { return; }

          if (handleSyncEvent(evt)) {
            syncEventSource.close();
            finishSync(evt);
          }
        };
        syncEventSource.onerror = function() {
          syncEventSource.close();
          syncEventSource = null;
          pollSyncStatus();
        };
      } else if (data.state === "complete" || data.state === "failed") {
        var cls = data.state === "complete" ? "success" : "error";
        createResultCard(
          data.state === "complete" ? "Sync complete" : "Sync failed", cls);
        document.getElementById("result-summary").textContent = data.summary || "";
      }
    })
    .catch(function() {});
  }

  document.getElementById("save-btn").addEventListener("click", function() {
    doSave(false);
  });
  document.getElementById("exit-btn").addEventListener("click", function() {
    doSave(true);
  });
  document.getElementById("quit-btn").addEventListener("click", function() {
    if (!confirm("Exit without saving?")) return;
    disableButtons();
    var msg = document.getElementById("status-msg");
    msg.textContent = "Closing...";
    msg.className = "status-msg";
    fetch("/api/exit", { method: "POST" }).catch(function() {});
    window.close();
    setTimeout(function() {
      msg.textContent = "Server stopped. You can close this tab.";
    }, 500);
  });
  document.getElementById("sync-btn").addEventListener("click", doSync);
  document.getElementById("verify-btn").addEventListener("click", doVerify);

  function updateDeleteToggleStyle() {
    var cb = document.getElementById("delete-toggle");
    var label = document.getElementById("delete-toggle-label");
    if (cb.checked) {
      label.classList.add("danger");
    } else {
      label.classList.remove("danger");
    }
  }

  document.getElementById("delete-toggle").addEventListener("change", updateDeleteToggleStyle);

  fetch("/api/systems")
    .then(function(res) { return res.json(); })
    .then(function(data) {
      systems = data.systems || [];
      var cb = document.getElementById("delete-toggle");
      cb.checked = !!data.delete;
      updateDeleteToggleStyle();
      render();
      checkSyncStatus();
      waitForShutdown();
    })
    .catch(function(err) {
      document.getElementById("loading").textContent = "Error loading: " + err.message;
    });
})();
</script>
</body>
</html>
